{% extends "base.html" %} {% load static %} {% block content %}

<div class="page-content container container-plus" style="background-color: white;">
  <!-- page header -->
  <div class="d-lg-none page-header py-0">
    <h1 class="text-dark-m3 pb-0 mb-0 text-125">Dashboard</h1>

    <!-- page tools -->
    <div class="page-tools d-none">
      <div class="action-buttons text-nowrap">
        <a
          class="btn bgc-white btn-light-secondary mx-0"
          data-toggle="tooltip"
          title="Details"
        >
          <i class="fa fa-search-plus text-blue"></i>
        </a>
        <a
          class="btn bgc-white btn-light-secondary mx-0"
          data-toggle="tooltip"
          title="Print"
        >
          <i class="fa fa-print text-purple"></i>
        </a>
        <a
          class="btn bgc-white btn-light-secondary mx-0"
          data-toggle="tooltip"
          title="Remove"
        >
          <i class="fa fa-trash-alt text-danger"></i>
        </a>
      </div>
    </div>
  </div>

  <div class="d-flex flex-wrap">
    <form action="{% url 'facebook_summary' %}" method="post">
      {% csrf_token %}
      <select
        class="selectpicker testselect m-2"
        name="facebook_select"
        multiple
        data-actions-box="true"
        data-live-search="true"
        data-selected-text-format="count > 3"
        data-style="btn-white"
        title="Choose options"
      >
        <!-- <option data-tokens="Mustard">Mustard</option>
        <option data-tokens="Ketchup">Ketchup</option>
        <option data-tokens="Relish">Relish</option>
        <option data-tokens="Akash">Akash</option> -->

        {% for item in shopTBAllSelect %} 
            {% if item.id in selected_shop %}
                <option value="{{item.id}}" selected>{{item.shopname}}</option>
            {% else %}
                <option value="{{item.id}}">{{item.shopname}}</option>
            {% endif %} 
        {% endfor %}
      </select>

      <button type="submit" class="btn btn-primary m-2">Apply</button>
    </form>
  </div>
  <div class="row mt-4">
    <div class="col-12 col-lg-6 mt-2 mt-lg-0 pr-lg-2">
      <div class="shadow rounded bcard card h-100 pt-0 mx-auto border-2">
        <div class="card-header border-0 bgc-success">
          <h5
            class="card-title text-120 pl-1 text-white"
            style="font-weight: 600"
          >
            Compliments
          </h5>
        </div>

        <div class="card-body p-3">
          <div
            class="d-flex align-items-start justify-content-center flex-wrap"
          ></div>

          {% for item in result.compliment %}

          <div class="btn-group border-outline-success px-2 m-1">
            <button
              type="button"
              class="btn btn-outline-success text-truncate"
              style="max-width: 500px; font-weight: bolder"
            >
              <span
                class="badge ml-auto shadow radius-round text-110 px-25"
                style="font-weight: 600"
              >
                {{item.aspect}}
              </span>

              <span
                class="badge ml-auto shadow radius-round text-90 px-25"
              >
                {{item.positive_count}}
              </span>
            </button>
            <!-- <button type="button" class="btn btn-primary">
              <i class="fa fa-trash-alt text-white text-120 mt-3px"></i>
            </button> -->
          </div>
          {% endfor %}
        </div>
        <!-- .card-body -->
      </div>
    </div>

    <div class="col-12 col-lg-6 mt-2 mt-lg-0 pr-lg-2">
      <div
        class="shadow bcard card h-100 pt-0 mx-auto border-danger-l1 border-2"
      >
        <div class="card-header border-0 bgc-danger">
          <h5
            class="card-title text-120 text-white pl-1"
            style="font-weight: 600"
          >
            Need for Improvement
          </h5>
        </div>

        <div class="card-body p-3">
          <div
            class="d-flex align-items-start justify-content-center flex-wrap"
          ></div>

          {% for item in result.improvment %}
          <div class="btn-group border-outline-primary px-2 m-1">
            <button
              type="button"
              class="btn btn-outline-danger text-truncate"
              style="max-width: 250px"
            >
              <span
                class="badge ml-auto shadow radius-round text-110 px-25"
              >
                {{item.aspect}}
              </span>
              <span
                class="badge ml-auto shadow radius-round text-90 px-25"
              >
                {{item.negative_count}}
              </span>
            </button>
            <!-- <button type="button" class="btn btn-primary">
              <i class="fa fa-trash-alt text-white text-120 mt-3px"></i>
            </button> -->
          </div>
          {% endfor %}
        </div>
        <!-- .card-body -->
      </div>
    </div>
  </div>
  <!-- /.row -->

  <div class="row mt-4">
    <div class="col-12 col-lg-8 mt-3 mt-lg-0 pl-lg-3">
      <div class="shadow rounded bcard card h-100">
        <div class="card-header border-2" style="background-color: lavender;">
          <h5 class="card-title font-normal text-120 text-dark-m1 pl-1">
            Positive vs Negative Reviews
          </h5>

          <!-- dropdown menu -->
          <div class="card-toolbar no-border">
            <div class="dropdown dd-backdrop dd-backdrop-none-md">
              <a
                class="btn btn-sm btn-lighter-secondary text-600 btn-bgc-white brc-secondary-l1 brc-h-secondary-m4 ml-1 dropdown-toggle"
                role="button"
                data-toggle="dropdown"
                data-display="static"
                aria-haspopup="true"
                aria-expanded="false"
              >
                <i class="far fa-calendar-check mr-2px"></i>
                <span class="text-wrap" id="current_year"
                  >{{result.barchart_dropdown.0}}</span
                >
                <i class="fa fa-caret-down ml-2px"></i>
              </a>
              <div
                class="dropdown-menu dropdown-menu-right dropdown-caret dropdown-animated dd-appear-center dd-slide-none-md"
              >
                <div class="dropdown-inner" id="yae">
                  {% for i in result.barchart_dropdown %}
                  <a
                    class="dropdown-item m-1 btn btn-sm btn-light-secondary btn-h-light-blue btn-a-blue text-600"
                    onClick="reply_click(this.id)"
                    id="{{i}}"
                    >{{i}}</a
                  >
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card-body p-1 p-md-3 h-100 d-flex align-items-center">
          <canvas
            id="revenue-expense-chart"
            class="mx-md-0"
            height="140"
          ></canvas>
        </div>
        <!-- .card-body -->
      </div>
    </div>
    <div class="col-12 col-lg-4 mt-2 mt-lg-0 pr-lg-2">
      <div class="bcard card h-100 pt-0 mx-auto">
        <div class="card-header border-2" style="background-color: lavender;">
          <h5 class="card-title text-120 text-dark-m1 pl-1" style="font-weight: 600;">Facebook Page</h5>
        </div>

        <div class="card-body p-3 d-flex flex-column shadow rounded">
          <div
            class="align-items-start justify-content-center flex-wrap"
          >
            <div class="d-flex pos-rel align-items-center justify-content-center">
              <!-- <div class="position-center text-center text-default-d2 mt-n25">
                <span> total </span>
                <span class="mt-n2 d-block text-200 text-secondary-d3 text-600">
                  55k
                </span>
              </div> -->

              <canvas
                id="facebook-page-chart2"
                class="pos-rel mb-3"
                style="
                  height: 220px;
                  width: 220px;
                  max-height: 220px;
                  max-width: 220px;
                "
              ></canvas>
            </div>
          </div>
        
          
        </div>
        <!-- .card-body -->
         
      </div>
    </div>
   
  </div>
  <!-- Latest compiled and minified JavaScript -->

  <div class="mt-4 d-flex justify-content-between align-items-center flex-wrap">
    <h4 class="font-weight-bold">
      You have {{result.piechart.total_review}} reviews
    </h4>
    <span
          class="badge bgc-white border-2 brc-purple-m1 text-dark-tp3 badge-pill badge-lg pb-4 bgc-h-purple-l3 "
        
          >Most Recent
        </span>
   
  </div>
  <div class="row mt-4">
    {% for item in result.reviewdata_random%}

    <div class="col-lg-6 col-md-12 my-2 pr-lg-2">
      <div class="shadow bcard card h-100 pt-0 mx-auto">
        <div class="card-header border-0 d-flex">
          <div class="d-flex jutify-content-start">
            <div class="m-0 p-2">
              <img
                src="{% static 'facebook.png' %}"
                style="height: 55px; width: 55px"
                class="rounded-circle"
              />
            </div>
            <div
              class="d-flex flex-column align-items-start justify-content-center"
            >
            <span>
                
                <i class="fas fa-map-marker-alt"></i>
                {{item.shop_id.shopname}}
              </span>
              <div class="d-flex flex-row  flex-wrap   ">
                <span class="font-weight-bold" style="font-size: 14px">
                  <i class="far fa-user mr-1 pt-3" style="font-size: 14px"></i>
                  {{item.username}}
                </span>
                <span class=" ml-2" style="font-size: 12px">
                  <i class="far fa-calendar-alt mr-1 pt-3" style="font-size: 12px"></i>
                  {{item.timestamp|make_list|slice:'8:10'|join:''}}-{{item.timestamp|make_list|slice:'5:7'|join:''}}-{{item.timestamp|make_list|slice:':4'|join:''}}
                </span>
              </div>
            </div>
          </div>
          <div class="d-flex jutify-content-end align-items-center">
            {% if item.sentiment >= 0.25 %}
            <span
              class="p-2 badge badge-success m-2 rounded"
              style="font-size: 15px"
              >Positive</span
            >
            {% elif item.sentiment <= -0.25 %}
            <span
              class="p-2 badge badge-danger m-2 rounded"
              style="font-size: 15px"
              >Negative</span
            >
            {% else %}
            <span
              class="p-2 badge badge-primary m-2 rounded"
              style="font-size: 15px"
              >Neutral</span
            >
            {% endif %}
          </div>
        </div>

        <div class="card-body px-4 pt-1 pm-3">
          <div
            class="text-truncate"
            style="max-height: 50px; white-space: unset"
          >
            {{item.review}}
          </div>
        </div>
        <!-- .card-body -->
      </div>
    </div>

    {% endfor %}
    <div class="col-lg-6 col-md-12 my-2 pr-lg-2">
      <form method="POST" action="{% url 'review_analysis' %}">
        {% csrf_token %}
          <input type="hidden" name="source_select" value="Facebook"/>
          <input type="hidden" name="place_select" value="{{selected_shop}}" />
          <input type="hidden" name="forWhat" value="summary" />
      <div class="shadow bcard card h-100 pt-0 mx-auto">
        <div
          class="card-header border-0 d-flex"
          style="
            -webkit-filter: blur(1px);
            -moz-filter: blur(1px);
            -o-filter: blur(1px);
            -ms-filter: blur(1px);
            filter: blur(1px);
          "
        >
          <div class="d-flex jutify-content-start">
            <div class="m-0 p-2">
              <img
                src="{% static 'facebook.png' %}"
                style="height: 55px; width: 55px"
                class="rounded-circle"
              />
            </div>
            <div
              class="d-flex flex-column align-items-start justify-content-center"
            >
            <span>
                
              <i class="fas fa-map-marker-alt"></i>
              {{result.reviewdata_randomblur.shop_id.shopname}}
            </span>
             
            <div class="d-flex flex-row  flex-wrap   ">
              <span class="font-weight-bold" style="font-size: 14px">
                <i class="far fa-user mr-1 pt-3" style="font-size: 14px"></i>
                {{result.reviewdata_randomblur.username}}
              </span>
              <span class=" ml-2" style="font-size: 12px">
                <i class="far fa-calendar-alt mr-1 pt-3" style="font-size: 12px"></i>
                {{result.reviewdata_randomblur.timestamp|make_list|slice:'8:10'|join:''}}-{{result.reviewdata_randomblur.timestamp|make_list|slice:'5:7'|join:''}}-{{result.reviewdata_randomblur.timestamp|make_list|slice:':4'|join:''}}
              </span>
            </div>
            </div>
          </div>
          <div class="d-flex jutify-content-end align-items-center">
            {% if result.reviewdata_randomblur.sentiment >= 0.25 %}
            <span
              class="p-2 badge badge-success m-2 rounded"
              style="font-size: 15px"
              >Positive</span
            >
            {% elif result.reviewdata_randomblur.sentiment <= -0.25 %}
            <span
              class="p-2 badge badge-danger m-2 rounded"
              style="font-size: 15px"
              >Negative</span
            >
            {% else %}
            <span
              class="p-2 badge badge-primary m-2 rounded"
              style="font-size: 15px"
              >Neutral</span
            >
            {% endif %}
          </div>
        </div>

        <div
          class="card-body px-4 pt-1 pm-3"
          style="
            -webkit-filter: blur(1px);
            -moz-filter: blur(1px);
            -o-filter: blur(1px);
            -ms-filter: blur(1px);
            filter: blur(1px);
          "
        >
          <div
            class="text-truncate"
            style="max-height: 50px; white-space: unset"
          >
            {{result.reviewdata_randomblur.review}}
          </div>
        </div>
        <!-- .card-body -->
        <div
          class="pos-abs bcard card w-100 h-100 justify-content-center modal-backdrop fade show bg-secondary"
          style="z-index: 10"
        ></div>
        <div
          class="pos-abs bcard card w-100 h-100 justify-content-center"
          style="z-index: 11; background-color: transparent"
        >
          <div class="mx-auto">
            <div class="d-flex justify-content-center">
              <button class="btn btn-primary">See All Reviews</button>
            </div>
          </div>
        </div>
      </div>
      </form>
    </div>
  </div>

  {{result.piechart|json_script:"fbdata" }}



  <script>
    var _animate = !AceApp.Util.isReducedMotion();

    /////////////////////////////////////////////
    


    

    // revenue vs expense bar chart

    var a = parseInt("{{result.barchart_dropdown.0}}");
    var arr_chart ={{result.barchart | safe}};
    var arr_chart_posi = arr_chart[a]["positive"];
    var arr_chart_negi = arr_chart[a]["negative"];

    var barchartupdate;
    barchartupdate = new Chart(
      document.getElementById("revenue-expense-chart").getContext("2d"),
      {
        type: "bar",
        data: {
          labels: [
            "Jan",
            "Feb",
            "Mar",
            "Apr",
            "May",
            "June",
            "Jul",
            "Aug",
            "Sep",
            "Oct",
            "Nov",
            "Dec",
          ],
          datasets: [
            {
              label: "Positive",
              data: arr_chart_posi,

              borderWidth: 0,
              backgroundColor: "#5bb15b",
              hoverBackgroundColor: "#5bb15b",

              barPercentage: 0.7,
              categoryPercentage: 0.7,
            },
            {
              label: "Negative",
              data: arr_chart_negi,

              borderWidth: 0,
              backgroundColor: "#da4e35",
              hoverBackgroundColor: "#da4e35",

              barPercentage: 0.6,
              categoryPercentage: 0.6,
            },
          ],
        },
        options: {
          cornerRadius: 4,
          legend: {
            display: true,
          },
          animation: {
            duration: _animate ? 1000 : false,
          },
          scales: {
            yAxes: [
              {
                ticks: {
                  fontFamily: "Open Sans",
                  fontColor: "#a0a4a9",
                  fontStyle: "600",
                  fontSize: "12",
                  beginAtZero: false,
                  maxTicksLimit: 8,
                  padding: 16,
                  callback: function (value, index, values) {
                    var val = parseInt(value);
                    return val;
                  },
                },
                gridLines: {
                  zeroLineColor: "transparent",
                  drawTicks: false,
                  display: false,
                },
              },
            ],
            xAxes: [
              {
                gridLines: {
                  zeroLineColor: "transparent",
                  display: true,
                  borderDash: [2, 3],
                  tickMarkLength: 3,
                },
                ticks: {
                  fontFamily: "Open Sans",
                  fontColor: "#808489",
                  fontSize: "13",
                  fontStyle: "400",
                  padding: 12,
                },
              },
            ],
          },

          tooltips: {
            enabled: true,
            callbacks: {
              label: function (tooltipItem, data) {
                var label = data.datasets[tooltipItem.datasetIndex].label || "";

                if (label) {
                  label += ": ";
                }
                label += parseFloat(tooltipItem.yLabel) + " Reviews";
                return label;
              },
            },
          },
        },
      }
    );

    ///

    var config = {
      type: "gauge",
      data: {
        labels: ["Success", "Warning", "Warning", "Error"],
        datasets: [
          {
            data: [20, 20, 20, 20],
            value: [20, 20, 20, 20],
            backgroundColor: ["green", "yellow", "orange", "red"],
            borderWidth: 2,
          },
        ],
      },
      options: {
        responsive: true,
        title: {
          display: true,
          text: "Gauge chart",
        },
        layout: {
          padding: {
            bottom: 30,
          },
        },
        needle: {
          // Needle circle radius as the percentage of the chart area width
          radiusPercentage: 2,
          // Needle width as the percentage of the chart area width
          widthPercentage: 3.2,
          // Needle length as the percentage of the interval between inner radius (0%) and outer radius (100%) of the arc
          lengthPercentage: 80,
          // The color of the needle
          color: "rgba(0, 0, 0, 1)",
        },
        valueLabel: {
          formatter: Math.round,
        },
      },
    };

    window.onload = function () {
      var ctx = document.getElementById("chart").getContext("2d");
      window.myGauge = new Chart(ctx, config);
    };

    $(document).ready(function () {
      $(".testselect").selectpicker();

      var x = $(".testselect button.bs-placeholder");
      console.log(
        x.append(
          '<i class="fas fa-sort-down " style="font-size:20px;margin-top:-5px"></i>'
        )
      );
    });

    function reply_click(clicked_id) {
      // var arr_chart={{yearsdata | safe}};
      arr_chart_posi = arr_chart[parseInt(clicked_id)]["positive"];
      arr_chart_negi = arr_chart[parseInt(clicked_id)]["negative"];
      document.getElementById("current_year").innerHTML = clicked_id;

      barchartupdate.data.datasets[0].data = arr_chart_posi;
      barchartupdate.data.datasets[1].data = arr_chart_negi;
      barchartupdate.update();
    }
  </script>
<script>
    ////chart2

    var facebookPageCanvas2 = document.getElementById("facebook-page-chart2");

    const data = JSON.parse(document.getElementById("fbdata").textContent);
  var arrData2 = [
  data.total_positive_review,
  data.total_neutral_review,
  data.total_negative_review,
  ];

var config_facebook = {
  type: "doughnut",
  data: {
    datasets: [
      {
        label: "Facebook Data",
        data: arrData2,
        backgroundColor: ["#42b254", "#2a8dcb", "#B22222"],
      },
    ],
    labels: ["Positive Reviews", "Neutral Reviews", "Negative Reviews"],
  },

  options: {
    responsive: true,

    cutoutPercentage: 0,
    legend: {
      display: false,
    },
    animation: {
      animateRotate: true,
      duration: _animate ? 1000 : false,
    },
    tooltips: {
      enabled: true,
      cornerRadius: 0,
      bodyFontColor: "#fff",
      bodyFontSize: 14,
      fontStyle: "bold",

      backgroundColor: "rgba(34, 34, 34, 0.73)",
      borderWidth: 0,

      caretSize: 5,

      xPadding: 12,
      yPadding: 12,

      callbacks: {
        label: function (tooltipItem, data) {
          return (
            " " +
            data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index]
          );
        },
      },
    },
  },
};

var facebookPagePieChart2 = new Chart(facebookPageCanvas2, config_facebook);

// place legends
$(facebookPageCanvas2)
  .parent()
  .after(
    "<div id='facebook-page-legends2' class='d-flex align-items-center justify-content-center piechart-legends text-95 text-secondary-d3 pt-3'>" +
      facebookPagePieChart2.generateLegend() +
      "</div>"
  );

var facebookPageChart_Legends_Wrapped2 =
  document.getElementById("facebook-page-legends2").offsetTop >
  facebookPageCanvas2.offsetTop + facebookPageCanvas2.offsetHeight;

</script>
  <script src="https://unpkg.com/chart.js@2.8.0/dist/Chart.bundle.js"></script>
  <script src="https://unpkg.com/chartjs-gauge@0.2.0/dist/chartjs-gauge.js"></script>
  <script>
    var config = {
      type: "gauge",
      data: {
        labels: ["Success", "Warning", "Warning", "Error"],
        datasets: [
          {
            data: [15, 45, 75, 80],
            value: 20,
            backgroundColor: ["#42b254", "#2a8dcb", "#9957bc", "#efcc4e"],
            borderWidth: 2,
          },
        ],
      },
      options: {
        responsive: true,
        title: {
          display: true,
          text: "Rating",
        },
        layout: {
          padding: {
            bottom: 30,
          },
        },
        tooltips: {
          enabled: true,
        },
        needle: {
          // Needle circle radius as the percentage of the chart area width
          radiusPercentage: 2,
          // Needle width as the percentage of the chart area width
          widthPercentage: 3.2,
          // Needle length as the percentage of the interval between inner radius (0%) and outer radius (100%) of the arc
          lengthPercentage: 80,
          // The color of the needle
          color: "rgba(0, 0, 0, 1)",
        },
        valueLabel: {
          formatter: Math.round,
        },
      },
    };

    window.onload = function () {
      var ctx = document.getElementById("chart").getContext("2d");
      window.myGauge = new Chart(ctx, config);
    };
  </script>
  

  {% endblock %}
</div>
